<!-- courses.ejs -->
<!DOCTYPE html>
<html>

  <title>Courses</title>
  <%- include('partials/header') %>

<body>
  <!-- Navigation -->
  <%- include('partials/clientNav') %>
  <h1>Courses</h1>
  
  <!-- Create Course Form -->
  <h2>Create Course</h2>
  <form id="course-form" action="/course/created" enctype="multipart/form-data" method="POST">
    <input type="text" name="title" placeholder="Title" >
    <textarea name="courseDesc" placeholder="Course Description"  cols="30" rows="5"></textarea>
   
    
    <div class="mb-3">
      <label for="imageUpload" class="form-label">Select Image</label>
      <input type="file" class="form-control" id="imageUpload" name="imageUpload">
    </div>
    <label for="category">Category:</label> 
    <!-- <select id="category" name="category"></select> -->
    <select id="category" name="category">
      <% categories.forEach((category) => { %>
        <option value="<%= category._id %>"><%= category.name %></option>
      <% }) %>
    </select>
    <input type="text" name="courseVideo" placeholder="Course Video URL">
    <button type="submit">Create Course</button>  
  </form>
  <p id="error"></p>
  <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
    <div class="errors">
      <% errors.forEach(function (error) { %>
        <p class="error-message"><%= error.msg %></p>
      <% }) %>
    </div>
  <% } %>
  <!-- List of Courses -->

  <% courses.forEach(function(course) { %>
    <div class="course">
      <h3><%= course.title %></h3>
      <% if(course.courseImage != ""){%>
        <img width="200px" src="<%=course.courseImage %>" />
      <%}%> 
      <p>Course No: <%= course.courseNo %></p>
      <p><%= course.courseDesc %></p>
      <!-- <img src="<%= course.courseImage %>" alt="Course Image"> -->
      <a href="/course/course-topics/<%= course._id %>">View course</a>
      <form action="/courses/<%= course._id %>" method="PUT">
        <span><p class="deleteCourse" data-link-data="<%=course._id %>">Delete course</p></span>
      </form> 
      <a href="/course/edit/<%= course._id %>">Edit</a>
      
      <p><%= course.usersCount%> registered users</p>
      <p><%=course.completed%> users have completed the course</p>
      <% if (course.usersCount > 0){%>
        <% const completedPercentage = (course.completed/course.usersCount) * 100; %>
        <p><%=completedPercentage.toFixed(2)%> % course completion</p>
    
       
      <%}%>  
    
      <span><p>Course status: <%= course.active ?"Active":"inactive" %></p></span>
    </div>
    <div id="message" class="hidden"></div> 
  <% }); %>
  <script>
    $(document).ready(function() {
        $('.deleteCourse').click(function(event){
        event.preventDefault;
        
        var linkData = $(this).data('link-data');
         console.log(linkData); 
        var link = '/course/'+linkData;

        $.ajax({
          url: link,
          type:'DELETE',
          success: function(response){
           location.reload();
          },
          error: function(response){
            console.log(response);
            
          } 
        });

      });
    });
  </script>
  <script>
    $(document).ready(function() {
      $('#course-form').submit(function(event) {
        event.preventDefault(); // Prevent form submission
        
        // Clear previous error messages
        $('#error').empty();
  
        // Get form values
        var fields = [
          { name: 'title', label: 'Title' },
          { name: 'courseDesc', label: 'Course Description' },
          { name: 'imageUpload', label: 'Image' },
          { name: 'category', label: 'Category' },
          { name: 'courseVideo', label: 'Course Video URL' }
        ];
  
        // Perform validation
        var isValid = true;
  
        fields.forEach(function(field) {
          var value = $('*[name="' + field.name + '"]').val().trim();
          if (value === '') {
            $('#error').append('<p>Please enter ' + field.label + '.</p>');
            isValid = false;
          }
        });
  
        if (isValid) {
          // Submit the form if valid
          $('#course-form').unbind('submit').submit();
        }
      });
    });
  </script>
  <%- include('partials/footer') %>
</body>
</html>
