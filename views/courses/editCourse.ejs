<!-- editTopic.ejs -->
<!DOCTYPE html>
<html>

  <title>Edit Course</title>
  <%- include('../partials/header') %>
   <style>
    #message {
  transition: opacity 0.3s ease-in-out;
}

.hidden {
  opacity: 0;
}
   </style> 
<body>
  <!-- Navigation -->
  <% if(admin){ %>
    <%- include('../partials/navBar') %>
    <%}else {%>
      <%- include('../partials/clientNav') %>    
    <%}%> 
  
  <h1>Edit course</h1>
  <% if(admin){%>
    <a href="/admin/courses/"> <button >Back</button></a>
  <%} else{%> 
    <a href="../../course/created"> <button >Back</button></a>
  <% }%>  
  <form id="courseForm" action="/course/<%=course._id %>" >
    <input type="text" name="title" placeholder="Title" value="<%=course.title%>" >
    <textarea name="courseDesc" placeholder="Course Description"   cols="30" rows="5"><%=course.courseDesc%></textarea>
   
 
    <label for="category">Category:</label> 
    <!-- <select id="category" name="category"></select> -->
   
    <select id="category" name="category" selected="<%=course.category%>">
      <% categories.forEach((category) => { %>
       
        <% if(category._id.toString() == course.category.toString()){%>
            <option selected value="<%= category._id %>" ><%= category.name %></option>
        <%}else{%>    
            
        <option  value="<%= category._id %>" ><%= category.name%></option>
        <%}%>
      <% }) %>
    </select>
    <input type="text" name="courseVideo" placeholder="Course Video URL" value="<%=course.video%>">
    <button type="submit">Update course</button>  
  </form>
  <br>
 
  <div id="message" class="hidden"></div>  
  <img src="<%=course.courseImage%>" width="20%">
  <div class=" mt-2">
    <p>Upload course image</p>
    <form id="uploadImage"  enctype="multipart/form-data">
      <div class="mb-3">
        <input type="hidden" name="courseId" value="<%=course._id %>" />
        <label for="imageUpload" class="form-label">Select Image</label>
        <input type="file" class="form-control" id="image" name="imageUpload">
      </div>
      <button type="submit" class="btn btn-primary">Upload</button>
    </form>
  </div>
  <script>
    $(document).ready(function() {
      $('#courseForm').submit(function(event) {
        event.preventDefault();
  
        // Clear previous error messages
        $('.error-message').remove();
  
        // Perform validation
        var isValid = true;
  
        $('input[type="text"], textarea').each(function() {
          if ($(this).val().trim() === '') {
            $(this).after('<p class="error-message">This field is required.</p>');
            isValid = false;
          }
        });
  
        if (isValid) {
          var form = $(this);
          var url = form.attr('action');
  
          // Serialize the data
          var formData = form.serialize();
  
          // Send the PUT request
          $.ajax({
            url: url,
            type: 'PUT',
            data: formData,
            success: function(response) {
              console.log(response);
  
              // Display success message in green
              const $message = $('#message');
              $message.text('Course data saved').css('color', 'green').removeClass('hidden');
  
              // Hide the message after a few seconds with fade-out effect
              setTimeout(function() {
                $message.addClass('hidden');
              }, 5000);
            },
            error: function(response) {
              console.log(response.responseJSON);
              if (response.responseJSON) {
                const $message = $('#message');
                $message.text('').css('color', 'red').removeClass('hidden');
                response.responseJSON.errors.forEach(function(element) {
                  console.log(element);
                  $message.append("<br>" + element.msg);
                });
              }
            }
          });
        }
      });
  
      // Update image
      $('#uploadImage').submit(function(event) {
      event.preventDefault();

      // Clear previous error messages
      $('.error-message').remove();

      // Perform validation
      var isValid = true;
      var fileInput = $('#image');

      if (fileInput[0].files.length === 0) {
        fileInput.after('<p class="error-message">Please select an image to upload.</p>');
        isValid = false;
      }

      if (isValid) {
        var formData = new FormData(this);

        $.ajax({
          url: '/course/image',
          type: 'PUT',
          data: formData,
          contentType: false,
          processData: false,
          success: function(response) {
            console.log(response);

            // Display success message in green
            const $message = $('#message');
            $message.text('Image uploaded successfully.').css('color', 'green').removeClass('hidden');

            // Hide the message after a few seconds with fade-out effect
            setTimeout(function() {
              $message.addClass('hidden');
            }, 5000);

            // Refresh the page to show the updated image
            location.reload();
          },
          error: function(response) {
            console.log(response);

            // Display error message in red
            const $message = $('#message');
            $message.text('Image upload failed. Please try again.').css('color', 'red').removeClass('hidden');
          }
        });
      }
    });
    });
  </script>
 <%- include('../partials/footer') %>
</body>
</html>